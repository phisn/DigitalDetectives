<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title></title>
  </head>
  <body>
  <div class="jumbotron">
    <div id="playerdata"></div>
    <div id="doubleticket"></div>
  <p><b id="blacktitle"></b></p>
	<form class="black" id="black" action="" method="post">
  </form>
	<p><b id="taxititle"></b></p>
  <form class="taxi" id="taxi" action="" method="post">
  </form>
	<p><b id="bustitle"></b></p>
  <form class="bus" id="bus" action="" method="post">
  </form>
	<p><b id="undergroundtitle"></b></p>
  <form class="underground" id="underground" action="" method="post">
  </form>
	</div>
  </body>
  <style>
  p {
  text-align: center;
}

div, h3 {
  text-align: center;
}

button {
	margin-right: 3px;
}

.black{
  background-color: black;
  padding: 20px;
  margin-bottom:10px;
}

.taxi {
  background-color: yellow;
  padding: 20px;
  margin-bottom:10px;
}

.bus {
  background-color: green;
  padding: 20px;
  margin-bottom:10px;
}

.underground {
  background-color: red;
  padding: 20px;
  margin-bottom:10px;
}

.ferry {
  background-color: blue;
  padding: 20px;
  margin-bottom:10px;
}
</style>
<script language="javascript">
  var d;
  var type, playerCount, playerID, playerType, position, yellowTicketCount, greenTicketCount, redTicketCount, positionVillianReveal, blackTicketCount, doubleTicketCount, turnFerryCount, turnFerry, turnYellowCount, turnGreenCount, turnRedCount;
let cookie = document.cookie.replace(/(?:(?:^|.*;\s*)pid\s*\=\s*([^;]*).*$)|^.*$/, "$1");
	var pid = parseInt(cookie, 10);
	if (pid == 0 || isNaN(cookie)) {
		alert("Got invalid PlayerID, reconnecting soon");

		setTimeout(function () {
			location.reload();
		}, 300);
	}

	let socket = new WebSocket("ws://" + document.domain + "/ws?pid=" + cookie);
	socket.binaryType = "arraybuffer";
		
	socket.onmessage = function (event) {
d = new DataView(event.data);

type = d.getUint8(0); playerCount = d.getUint8(1); playerID = d.getUint8(2); playerType = d.getUint8(3); position = d.getUint8(4); yellowTicketCount = d.getUint8(5); greenTicketCount = d.getUint8(6); redTicketCount = d.getUint8(7); positionVillianReveal = d.getUint8(8); blackTicketCount = d.getUint8(9); doubleTicketCount = d.getUint8(10); turnFerryCount = d.getUint8(26); turnFerry = d.getUint8(27); turnYellowCount = d.getUint8(29); turnGreenCount = d.getUint8(30); turnRedCount = d.getUint8(31); 

switch(type){
  case 3:

var redDetTickets = new Array(d.getUint8(11),d.getUint8(16),d.getUint8(21)); //YELLOW - GREEN - RED
var greenDetTickets = new Array(d.getUint8(12),d.getUint8(17),d.getUint8(22));
var blueDetTickets = new Array(d.getUint8(13),d.getUint8(18),d.getUint8(23));
var purpleDetTickets = new Array(d.getUint8(14),d.getUint8(19),d.getUint8(24));
var yellowDetTickets = new Uint8Array(d.getUint8(15),d.getUint8(20),d.getUint8(25));

var html = '';
html += '<h3>Currently on ' + position + '</h3>';
html += '<p><b>Tickets: </b>' + blackTicketCount + ' Black, ' + doubleTicketCount + ' Double, ' + yellowTicketCount + ' Taxi, ' + greenTicketCount + ' Bus, ' + redTicketCount + ' Underground</p>'


html += '<p><i><b>Tickets of RED: </b>' + redDetTickets[0] + ' Taxi, ' + redDetTickets[1] + ' Bus, ' + redDetTickets[2] + ' Underground</i></p>';
html += '<p><i><b>Tickets of GREEN: </b>' + greenDetTickets[0] + ' Taxi, ' + greenDetTickets[1] + ' Bus, ' + greenDetTickets[2] + ' Underground</i></p>';
html += '<p><i><b>Tickets of BLUE: </b>' + blueDetTickets[0] + ' Taxi, ' + blueDetTickets[1] + ' Bus, ' + blueDetTickets[2] + ' Underground</i></p>';

if(playerCount > 3){
  html += '<p><i><b>Tickets of PURPLE: </b>' + purpleDetTickets[0] + ' Taxi, ' + purpleDetTickets[1] + ' Bus, ' + purpleDetTickets[2] + ' Underground</i></p>';
}
if(playerCount > 4){
  html += '<p><i><b>Tickets of YELLOW: </b>' + yellowDetTickets[0] + ' Taxi, ' + yellowDetTickets[1] + ' Bus, ' + yellowDetTickets[2] + ' Underground</i></p>';
}

html += '<p>Your position is revealed in <b>' + positionVillianReveal + '</b> moves</p>';

if(doubleTicketCount > 0){
  html += '<label> <input name="doubleTicket" type="checkbox" onclick="generateButtons(this.checked)"> Use Double-Ticket </label>';
}

document.getElementById('playerdata').innerHTML = html;

if(pid === playerID){
  generateButtons(false);
}
break;
case 4:
alert('ERROR 4');
break;
}
}
function generateButtons(useDoubleTicket){
  switch(type){
    case 3:
  var dname = '';
  if(useDoubleTicket){
    dname = 'd'
  }

  var blackTurns = new Array(17);
  
  for(var i = 32; i <= 46; i++){
    blackTurns[i-32] = d.getUint8(i);
  }

  blackTurns[15] = d.getUint8(27);
  blackTurns[16] = d.getUint8(28);

  if((!blackTurns.every(i => i === 0))){
    document.getElementById('blacktitle').innerHTML = 'Black';
    var _html = '';
    for(var i = 0; i < blackTurns.length; i++){
      var station = blackTurns[i];
      _html += '<button value=\"' + station + '\" type=\"submit\" name=\"b' + dname + '\" formmethod="post">' + station + '</button>';
    }
    document.getElementById('black').innerHTML = _html;
  }
  if(turnYellowCount > 0 && yellowTicketCount > 0){
    document.getElementById('taxititle').innerHTML = 'Taxi';
    var _html = '';
    for(var i = 32; i <= 37; i++){
      _html += '<button value=\"' + i + '\" type=\"submit\" name=\"y' + dname + '\" formmethod="post">' + i + '</button>';
    }
    document.getElementById('taxi').innerHTML = _html;
  }
  if(turnGreenCount > 0 && greenTicketCount > 0){
    document.getElementById('bustitle').innerHTML = 'Bus';
    var _html = '';
    for(var i = 38; i <= 42; i++){
      _html += '<button value=\"' + i + '\" type=\"submit\" name=\"g' + dname + '\" formmethod="post">' + i + '</button>';
    }
    document.getElementById('bus').innerHTML = _html;
  }
  if(turnRedCount > 0 && redTicketCount > 0){
    document.getElementById('undergroundtitle').innerHTML = 'Underground';
    var _html = '';
    for(var i = 43; i <= 46; i++){
      _html += '<button value=\"' + i + '\" type=\"submit\" name=\"r' + dname + '\" formmethod="post">' + i + '</button>';
    }
    document.getElementById('underground').innerHTML = _html;
  }
  break;
  case 4:
  alert('ERROR 4');
  break;
  }
}
</script>
</html>
